<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة مركز صلة التدريبي الدولي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Favicon -->
    <link rel="icon" href="https://placehold.co/32x32/3B82F6/FFFFFF?text=S" type="image/png">
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f4f8;
        }
        .tab-button.active {
            border-color: #3B82F6;
            color: #3B82F6;
            background-color: #EFF6FF;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            animation: slide-down 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes slide-down {
            from {
                transform: translateY(-30px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        .close-button {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Spinner for loading state */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #3B82F6;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">
        <!-- Header -->
        <header class="bg-white shadow-md rounded-lg p-6 mb-6 flex justify-between items-center">
             <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">إدارة مركز صلة التدريبي الدولي</h1>
                <p class="text-gray-500 mt-1">لوحة تحكم شاملة لإدارة شؤون المركز</p>
            </div>
             <div class="text-blue-500">
                <i class="fas fa-sitemap fa-2x"></i>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="mb-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-4 space-x-reverse" aria-label="Tabs">
                    <button onclick="showTab('trainees')" class="tab-button active whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm" data-tab="trainees">المتدربين</button>
                    <button onclick="showTab('instructors')" class="tab-button whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm" data-tab="instructors">المدربين</button>
                    <button onclick="showTab('schedule')" class="tab-button whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm" data-tab="schedule">جدولة الكورسات</button>
                </nav>
            </div>
        </div>

        <!-- Main Content Area -->
        <main>
            <!-- Trainees Section -->
            <div id="trainees" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <h2 class="text-xl font-bold text-gray-700">بيانات المتدربين</h2>
                        <button onclick="openModal('addTraineeModal')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors duration-200"><i class="fas fa-plus"></i> إضافة متدرب</button>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="traineeSearch" onkeyup="filterTrainees()" placeholder="ابحث عن اسم المتدرب..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="traineeList" class="mt-4 space-y-4">
                       <!-- Data will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Instructors Section -->
            <div id="instructors" class="tab-content" style="display: none;">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <h2 class="text-xl font-bold text-gray-700">بيانات المدربين</h2>
                        <button onclick="openModal('addInstructorModal')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors duration-200"><i class="fas fa-plus"></i> إضافة مدرب</button>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="instructorSearch" onkeyup="filterInstructors()" placeholder="ابحث عن اسم المدرب..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div id="instructorList" class="mt-4 space-y-4">
                        <!-- Data will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Schedule Section (Placeholder) -->
            <div id="schedule" class="tab-content" style="display: none;">
                <!-- ... as before ... -->
            </div>
        </main>
    </div>

    <!-- Modals (Add/Edit Trainee, Add/Edit Instructor, Confirm Delete) -->

    <!-- Add/Edit Trainee Modal -->
    <div id="traineeModal" class="modal">
        <div class="modal-content">
            <span onclick="closeModal('traineeModal')" class="close-button">&times;</span>
            <h3 id="traineeModalTitle" class="text-xl font-bold mb-4"></h3>
            <form id="traineeForm" class="space-y-4">
                <input type="hidden" name="id">
                <input type="text" name="full_name" placeholder="الاسم الثلاثي" class="w-full p-2 border rounded-lg" required>
                <input type="text" name="phone_number" placeholder="رقم الهاتف" class="w-full p-2 border rounded-lg">
                <input type="text" name="address" placeholder="السكن" class="w-full p-2 border rounded-lg">
                <input type="text" name="national_id" placeholder="الرقم الوطني" class="w-full p-2 border rounded-lg">
                <input type="date" name="dob" placeholder="التولد" class="w-full p-2 border rounded-lg">
                <input type="text" name="mother_name" placeholder="اسم الأم" class="w-full p-2 border rounded-lg">
                <input type="text" name="education_level" placeholder="التحصيل العلمي" class="w-full p-2 border rounded-lg">
                <button type="submit" id="saveTraineeBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"></button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Instructor Modal -->
    <div id="instructorModal" class="modal">
         <div class="modal-content">
            <span onclick="closeModal('instructorModal')" class="close-button">&times;</span>
            <h3 id="instructorModalTitle" class="text-xl font-bold mb-4"></h3>
            <form id="instructorForm" class="space-y-4">
                <input type="hidden" name="id">
                <input type="text" name="full_name" placeholder="الاسم الثلاثي" class="w-full p-2 border rounded-lg" required>
                <input type="text" name="phone_number" placeholder="رقم الهاتف" class="w-full p-2 border rounded-lg">
                <input type="text" name="address" placeholder="السكن" class="w-full p-2 border rounded-lg">
                <input type="text" name="national_id" placeholder="الرقم الوطني" class="w-full p-2 border rounded-lg">
                <input type="date" name="dob" placeholder="التولد" class="w-full p-2 border rounded-lg">
                <input type="text" name="mother_name" placeholder="اسم الأم" class="w-full p-2 border rounded-lg">
                <input type="text" name="education_level" placeholder="التحصيل العلمي" class="w-full p-2 border rounded-lg">
                <input type="text" name="specialization" placeholder="الاختصاص التدريبي" class="w-full p-2 border rounded-lg">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm text-gray-600">تاريخ التعاقد</label><input type="date" name="contract_start_date" class="w-full p-2 border rounded-lg"></div>
                    <div><label class="text-sm text-gray-600">تاريخ الانتهاء</label><input type="date" name="contract_end_date" class="w-full p-2 border rounded-lg"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">رفع السيرة الذاتية (PDF)</label>
                    <input type="file" id="instructorCv" name="cv" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    <p id="currentCv" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <button type="submit" id="saveInstructorBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                    <span id="btnText"></span>
                    <span id="btnSpinner" style="display:none;" class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Confirm Delete Modal -->
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content max-w-sm">
            <h3 class="text-xl font-bold mb-2">تأكيد الحذف</h3>
            <p id="confirmDeleteText" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-4">
                <button onclick="closeModal('confirmDeleteModal')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">إلغاء</button>
                <button id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">حذف</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Toast -->
    <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-2 px-5 rounded-lg shadow-lg" style="display: none; z-index: 200;">
        <p id="toast-message"></p>
    </div>


<script>
    // --- SUPABASE CLIENT SETUP ---
    const supabaseUrl = "https://sacorfhclmbubtablzuz.supabase.co";
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhY29yZmhjbG1idWJ0YWJsenV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4Njk0MjUsImV4cCI6MjA2NjQ0NTQyNX0.OjeACPPo0GJBirnPrfciyhch4XTUUKBBoYFacKRqoh8";
    
    let supabase;
    if (typeof supabaseUrl !== 'undefined' && typeof supabaseAnonKey !== 'undefined') {
        supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        console.log('Supabase client initialized.');
    } else {
        console.error('Supabase URL or Anon Key is not defined.');
        showToast('خطأ في الاتصال بقاعدة البيانات', 'error');
    }

    // --- GLOBAL STATE ---
    let allTrainees = [];
    let allInstructors = [];

    // --- UI/UX FUNCTIONS ---
    function showToast(message, type = 'info') { /* ... as before ... */ }
    function showTab(tabName) { /* ... as before ... */ }
    function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    window.onclick = (event) => { /* ... as before ... */ };
    
    const showLoading = (containerId) => {
        const container = document.getElementById(containerId);
        container.innerHTML = `<div class="flex justify-center p-8"><div class="loader"></div></div>`;
    };

    // --- TRAINEE LOGIC ---

    // Open trainee modal for adding or editing
    function openTraineeModal(trainee = null) {
        const form = document.getElementById('traineeForm');
        form.reset();
        const modalTitle = document.getElementById('traineeModalTitle');
        const saveBtn = document.getElementById('saveTraineeBtn');
        
        if (trainee) { // Editing existing trainee
            modalTitle.textContent = 'تعديل بيانات المتدرب';
            saveBtn.textContent = 'حفظ التعديلات';
            Object.keys(trainee).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) input.value = trainee[key];
            });
        } else { // Adding new trainee
            modalTitle.textContent = 'إضافة متدرب جديد';
            saveBtn.textContent = 'حفظ المتدرب';
            form.querySelector('[name="id"]').value = '';
        }
        openModal('traineeModal');
    }

    // Handle trainee form submission (Add/Update)
    document.getElementById('traineeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const traineeData = Object.fromEntries(formData.entries());
        const id = traineeData.id;

        let error;
        if (id) { // Update
            const { error: updateError } = await supabase.from('trainees').update(traineeData).eq('id', id);
            error = updateError;
        } else { // Insert
            delete traineeData.id;
            const { error: insertError } = await supabase.from('trainees').insert([traineeData]);
            error = insertError;
        }

        if (error) {
            console.error('Error saving trainee:', error);
            showToast('حدث خطأ أثناء حفظ بيانات المتدرب', 'error');
        } else {
            showToast(`تم ${id ? 'تعديل' : 'إضافة'} المتدرب بنجاح`, 'success');
            closeModal('traineeModal');
        }
    });

    // Confirm and delete a trainee
    function confirmDeleteTrainee(id, name) {
        const modal = document.getElementById('confirmDeleteModal');
        const text = document.getElementById('confirmDeleteText');
        const btn = document.getElementById('confirmDeleteBtn');
        text.textContent = `هل أنت متأكد أنك تريد حذف المتدرب "${name}"؟ لا يمكن التراجع عن هذا الإجراء.`;
        btn.onclick = () => deleteTrainee(id);
        openModal('confirmDeleteModal');
    }

    async function deleteTrainee(id) {
        const { error } = await supabase.from('trainees').delete().eq('id', id);
        if (error) {
            console.error('Error deleting trainee:', error);
            showToast('حدث خطأ أثناء الحذف', 'error');
        } else {
            showToast('تم حذف المتدرب بنجاح', 'success');
        }
        closeModal('confirmDeleteModal');
    }


    // Render all trainees
    function renderTrainees(traineesToRender) {
        const listContainer = document.getElementById('traineeList');
        if (traineesToRender.length === 0) {
            listContainer.innerHTML = '<p class="text-gray-500 text-center p-4">لا يوجد متدربون لعرضهم.</p>';
            return;
        }
        listContainer.innerHTML = traineesToRender.map(trainee => `
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 transition-shadow hover:shadow-md">
                <div class="flex justify-between items-start">
                    <h3 class="font-bold text-lg text-blue-700">${trainee.full_name}</h3>
                    <div class="flex gap-2">
                        <button onclick='openTraineeModal(${JSON.stringify(trainee)})' class="text-gray-500 hover:text-blue-600"><i class="fas fa-edit"></i></button>
                        <button onclick='confirmDeleteTrainee(${trainee.id}, "${trainee.full_name}")' class="text-gray-500 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 mt-3 text-sm">
                    <p><strong class="font-semibold text-gray-600">الرقم:</strong> ${trainee.phone_number || 'غير متوفر'}</p>
                    <p><strong class="font-semibold text-gray-600">السكن:</strong> ${trainee.address || 'غير متوفر'}</p>
                    <p><strong class="font-semibold text-gray-600">الرقم الوطني:</strong> ${trainee.national_id || 'غير متوفر'}</p>
                    <p><strong class="font-semibold text-gray-600">التولد:</strong> ${trainee.dob || 'غير متوفر'}</p>
                </div>
            </div>
        `).join('');
    }

    // Filter displayed trainees based on search input
    function filterTrainees() {
        const searchTerm = document.getElementById('traineeSearch').value.toLowerCase();
        const filtered = allTrainees.filter(t => t.full_name.toLowerCase().includes(searchTerm));
        renderTrainees(filtered);
    }
    
    // --- INSTRUCTOR LOGIC (similar structure to trainees) ---
     function openInstructorModal(instructor = null) {
        const form = document.getElementById('instructorForm');
        form.reset();
        const modalTitle = document.getElementById('instructorModalTitle');
        const saveBtn = document.getElementById('saveInstructorBtn').querySelector('#btnText');
        document.getElementById('currentCv').textContent = '';

        if (instructor) { // Editing
            modalTitle.textContent = 'تعديل بيانات المدرب';
            saveBtn.textContent = 'حفظ التعديلات';
            Object.keys(instructor).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) input.value = instructor[key];
            });
            if (instructor.cv_url) {
                document.getElementById('currentCv').innerHTML = `الملف الحالي: <a href="${instructor.cv_url}" target="_blank" class="text-blue-500">عرض</a>`;
            }
        } else { // Adding
            modalTitle.textContent = 'إضافة مدرب جديد';
            saveBtn.textContent = 'حفظ المدرب';
            form.querySelector('[name="id"]').value = '';
        }
        openModal('instructorModal');
    }
    
    // --- Real-time Data Subscription ---
    async function listenToChanges() {
        // Fetch initial data
        showLoading('traineeList');
        showLoading('instructorList');
        
        const { data: initialTrainees, error: traineesError } = await supabase.from('trainees').select('*');
        if (traineesError) console.error("Error fetching initial trainees", traineesError);
        else {
            allTrainees = initialTrainees;
            renderTrainees(allTrainees);
        }

        const { data: initialInstructors, error: instructorsError } = await supabase.from('instructors').select('*');
         if (instructorsError) console.error("Error fetching initial instructors", instructorsError);
        else {
            allInstructors = initialInstructors;
            renderInstructors(allInstructors); // A new function similar to renderTrainees
        }


        // Listen to changes for Trainees
        supabase.channel('trainees')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'trainees' }, (payload) => {
            console.log('Change received for trainees!', payload);
            if (payload.eventType === 'INSERT') {
                allTrainees.push(payload.new);
            } else if (payload.eventType === 'UPDATE') {
                const index = allTrainees.findIndex(t => t.id === payload.new.id);
                if (index > -1) allTrainees[index] = payload.new;
            } else if (payload.eventType === 'DELETE') {
                allTrainees = allTrainees.filter(t => t.id !== payload.old.id);
            }
            filterTrainees();
          })
          .subscribe();

        // Listen to changes for Instructors
        // (A similar subscription block for the 'instructors' table would go here)
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        showTab('trainees');
        listenToChanges();
        
        // Add dummy renderInstructors and filterInstructors to avoid errors until fully implemented
        window.renderInstructors = (instructors) => {
             const listContainer = document.getElementById('instructorList');
             if(!instructors || instructors.length === 0){
                listContainer.innerHTML = '<p class="text-gray-500 text-center p-4">لا يوجد مدربون لعرضهم.</p>';
                return;
             }
             listContainer.innerHTML = "قيد التطوير...";
        };
        window.filterInstructors = () => {};
    });

</script>

</body>
</html>
